{
    "system_metadata": {
        "title": "Мастер-промт: Оркестратор + Мультиагентная Система (Универсальный, формальный режим)",
        "version": "1.0",
        "date_created": "2025-10-27",
        "author": "Конфигурация по запросу пользователя",
        "purpose": "Управление выполнением сложных задач через Оркестратора и специализированные ИИ-агенты с протоколом достоверности, итеративным циклом и триггерами качества. Универсальный режим, формальный (деловой/юридический) стиль."
    },
    "execution_config": {
        "mode": "multi_agent",
        "communication_style": "formal_business_legal",
        "max_concurrent_agents": 10,
        "default_max_iterations": 5,
        "default_min_sources_per_key_fact": 2,
        "default_confidence_threshold": 0.95
    },
    "tasks": {
        "enabled": [
            "echo",
            "upper",
            "json_pretty"
        ]
    },
    "access": {
        "allowed_user_ids": []
    },
    "rate_limits": {
        "llm": {
            "per_minute": 10,
            "per_day": 200
        }
    },
    "llm": {
        "provider": "perplexity",
        "model": "sonar",
        "system_prompt": "Ты полезный ассистент. Отвечай кратко и по делу.",
        "history_turns": 5,
        "search_system_prompt": "Ты поисковый ассистент. Отвечай по фактам и добавляй ссылки (citations), если они есть."
    },
    "orchestrator": {
        "agent_id": "orchestrator_001",
        "name": "Оркестратор",
        "role": "Координация задач между агентами, контроль итераций, агрегирование и финальная верификация результатов.",
        "responsibilities": [
            "разбивать задачу на подзадачи и назначать исполнителей",
            "контролировать выполнение итераций и запуск триггеров качества",
            "агрегировать результаты агентов и формировать итоговый отчет",
            "вести версионный лог (audit trail) и хранить метаданные"
        ],
        "interaction_interface": {
            "accepts_message_types": [
                "task",
                "status_update",
                "verification_request",
                "escalation"
            ],
            "sends_message_types": [
                "task_assignment",
                "iteration_command",
                "escalation",
                "final_release"
            ]
        },
        "decision_rules": {
            "release_criteria": [
                "percent_confirmed_facts >= default_confidence_threshold",
                "conflict_rate <= 0.05",
                "critical_triggers == 0"
            ],
            "escalation_criteria": [
                "critical_triggers > 0",
                "iterations_exceeded_without_progress",
                "subject_matter_conflict_requires_human"
            ]
        }
    },
    "agents": [
        {
            "agent_id": "researcher_001",
            "name": "Исследователь (Researcher)",
            "role": "Сбор, верификация и ранжирование источников; подготовка исходной базы фактов.",
            "methodology": [
                "поиск первичных и вторичных источников",
                "пометка: url, название, автор, дата публикации, дата доступа",
                "оценка надежности источника по шкале 0.0-1.0",
                "сбор минимум default_min_sources_per_key_fact для ключевых утверждений"
            ],
            "outputs": [
                "sources_list",
                "extracted_facts",
                "source_reliability_scores"
            ],
            "interaction_interface": {
                "accepts": [
                    "task_assignment"
                ],
                "sends": [
                    "sources_list",
                    "extracted_facts",
                    "status_update"
                ]
            }
        },
        {
            "agent_id": "analyst_001",
            "name": "Аналитик (Analyst)",
            "role": "Критический анализ источников и фактов; выявление несоответствий и оценка вероятностей.",
            "methodology": [
                "сопоставление фактов между источниками",
                "оценка согласованности и вычисление conflict_rate",
                "выделение ключевых фактов и их confidence_score"
            ],
            "outputs": [
                "fact_consistency_report",
                "conflict_matrix",
                "confidence_scores"
            ],
            "interaction_interface": {
                "accepts": [
                    "sources_list",
                    "extracted_facts"
                ],
                "sends": [
                    "fact_consistency_report",
                    "recommendations",
                    "status_update"
                ]
            }
        },
        {
            "agent_id": "author_001",
            "name": "Автор (Author)",
            "role": "Формирование черновиков документов/отчётов/писем в формальном стиле на основании проверенных фактов.",
            "methodology": [
                "использовать входные факты и confidence_scores",
                "строго цитировать источники при каждом утверждении",
                "форматировать текст в соответствии с report_format_template"
            ],
            "outputs": [
                "draft_document",
                "inline_citations"
            ],
            "interaction_interface": {
                "accepts": [
                    "fact_consistency_report",
                    "task_input"
                ],
                "sends": [
                    "draft_document",
                    "status_update"
                ]
            }
        },
        {
            "agent_id": "critic_001",
            "name": "Критик / Рецензент (Critic)",
            "role": "Независимая рецензия черновика по фактам, логике и стилю; формулировка правок.",
            "methodology": [
                "проверка цитирования и соответствия источникам",
                "оценка юридической и логической связности",
                "предложение исправлений и пометок для доработки"
            ],
            "outputs": [
                "review_report",
                "corrections_list"
            ],
            "interaction_interface": {
                "accepts": [
                    "draft_document",
                    "sources_list"
                ],
                "sends": [
                    "review_report",
                    "corrections_list",
                    "status_update"
                ]
            }
        },
        {
            "agent_id": "verifier_001",
            "name": "Верификатор (Verifier)",
            "role": "Автоматическая проверка по триггерам качества, расчёт метрик и вынесение вердикта по итерации.",
            "methodology": [
                "запустить quality_triggers.checks",
                "подсчитать: percent_confirmed_facts, average_source_reliability, conflict_rate, broken_links_count, citation_coverage_percent",
                "сформировать machine_readable_quality_report и human_readable_summary"
            ],
            "outputs": [
                "quality_report",
                "quality_metrics",
                "trigger_flags"
            ],
            "interaction_interface": {
                "accepts": [
                    "draft_document",
                    "sources_list",
                    "fact_consistency_report"
                ],
                "sends": [
                    "quality_report",
                    "trigger_flags",
                    "status_update"
                ]
            }
        },
        {
            "agent_id": "legal_advisor_001",
            "name": "Юридический эксперт (LegalAdvisor)",
            "role": "Опциональный агент для предметно-специфичных юридических проверок и интерпретаций нормативной базы.",
            "methodology": [
                "оценка соответствия выводов нормативным актам",
                "подготовка ссылок на статьи законов/НПА",
                "выявление юридических рисков"
            ],
            "outputs": [
                "legal_opinion",
                "legal_references"
            ],
            "interaction_interface": {
                "accepts": [
                    "fact_consistency_report",
                    "draft_document"
                ],
                "sends": [
                    "legal_opinion",
                    "legal_references",
                    "status_update"
                ]
            }
        }
    ],
    "interaction_protocol": {
        "message_schema": {
            "message_type": "task|response|verification|critique|status|escalation",
            "from_agent_id": "string",
            "to_agent_id": "string",
            "task_id": "string",
            "iteration": "integer",
            "timestamp": "YYYY-MM-DDTHH:MM:SSZ",
            "payload": {}
        },
        "routing_rules": [
            "Orchestrator назначает task_id и направляет task_assignment соответствующему agent_id.",
            "Агенты отправляют статус каждые N минут или при завершении подзадачи.",
            "Все ответы включают ссылку на предыдущую версию (prev_task_id/prev_version)."
        ],
        "error_handling": {
            "on_agent_failure": "Orchestrator повторно назначает задачу другому агенту или эскалирует.",
            "on_timeout": "Если агент не ответил в пределах SLA — Orchestrator инициирует reassignment."
        }
    },
    "task_input_format": {
        "task_id": "string",
        "title": "string",
        "description": "string (четкая формулировка цели и ограничений)",
        "priority": "low|medium|high|critical",
        "domain": "string (e.g., legal, technical, strategic)",
        "required_outputs": [
            "e.g., draft_document, fact_table, recommendations"
        ],
        "deadline": "YYYY-MM-DDTHH:MM:SSZ (optional)",
        "attachments": [
            {
                "type": "url|file",
                "reference": "string"
            }
        ],
        "user_contact": {
            "name": "string",
            "role": "string",
            "contact": "string"
        }
    },
    "task_output_format": {
        "task_id": "string",
        "version": "integer",
        "author_agent_id": "string",
        "title": "string",
        "summary": "string (3-5 предложений)",
        "facts": [
            {
                "id": "fact_001",
                "statement": "string",
                "sources": [
                    {
                        "url": "string",
                        "title": "string",
                        "date_published": "YYYY-MM-DD",
                        "date_accessed": "YYYY-MM-DD",
                        "reliability_score": "0.0-1.0"
                    }
                ],
                "confidence_score": "0.0-1.0"
            }
        ],
        "analysis": "string (логика выводов, упоминание альтернатив)",
        "recommendations": [
            {
                "action": "string",
                "responsible": "string",
                "deadline": "YYYY-MM-DD"
            }
        ],
        "quality_metrics": {
            "percent_confirmed_facts": "number",
            "average_source_reliability": "number",
            "conflict_rate": "number",
            "broken_links_count": "integer",
            "citation_coverage_percent": "number"
        },
        "iteration_log": [
            {
                "iteration": "integer",
                "who": "agent_id",
                "what_changed": "string",
                "timestamp": "YYYY-MM-DDTHH:MM:SSZ"
            }
        ],
        "attachments": [],
        "final_decision": "released|requires_iteration|escalated",
        "notes": "string"
    },
    "iterative_protocol": {
        "goal": "Достичь требуемого уровня качества согласно quality_triggers или исчерпать итерации.",
        "max_iterations": 5,
        "iteration_flow": [
            "1. Orchestrator распределяет подзадачи и фиксирует iteration=1.",
            "2. Researcher собирает источники и помещает в payload.",
            "3. Analyst создаёт fact_consistency_report и оценивает конфликт_rate.",
            "4. Author формирует draft_document с inline_citations.",
            "5. Critic рецензирует draft_document и возвращает corrections.",
            "6. Verifier запускает quality_triggers и формирует quality_report.",
            "7. Orchestrator принимает решение: release / new_iteration / escalate."
        ],
        "stopping_criteria": [
            "quality_report.critical_triggers == 0",
            "quality_metrics.percent_confirmed_facts >= 95",
            "quality_metrics.conflict_rate <= 0.05",
            "или достигнут max_iterations"
        ],
        "logging": "Каждая итерация сохраняет полный лог: входы, выходы, версии документов и триггеры."
    },
    "quality_triggers": {
        "description": "Набор автоматических проверок, исполняемых Verifier после каждой итерации.",
        "checks": [
            {
                "id": "missing_citations",
                "severity": "critical",
                "rule": "Любое ключевое утверждение без хотя бы одного источника => FAIL",
                "action_on_fail": "Вернуть на доработку Author с указанием мест без источников"
            },
            {
                "id": "insufficient_independent_sources",
                "severity": "major",
                "rule": "Для критичных фактов количество независимых источников < default_min_sources_per_key_fact => WARN",
                "action_on_warn": "Запустить дополнительный поиск (Researcher) или отметить факт как требующий подтверждения"
            },
            {
                "id": "low_source_reliability",
                "severity": "major",
                "rule": "average_source_reliability < 0.6 => WARN",
                "action_on_warn": "Инициировать поиск более надежных источников"
            },
            {
                "id": "conflict_rate",
                "severity": "major",
                "rule": "conflict_rate > 0.10 => WARN; conflict_rate > 0.25 => FAIL",
                "action_on_warn": "Оркестратор назначает дополнительный аналитический цикл",
                "action_on_fail": "Эскалация к human operator или профильному эксперту"
            },
            {
                "id": "broken_links",
                "severity": "minor",
                "rule": "Любая ссылка, недоступная при проверке => WARN",
                "action_on_warn": "Researcher обновляет ссылку или находит альтернативный источник"
            },
            {
                "id": "formatting_rules",
                "severity": "minor",
                "rule": "Несоответствие report_format_template => WARN",
                "action_on_warn": "Author исправляет формат согласно шаблону"
            },
            {
                "id": "legal_basis_presence",
                "severity": "critical",
                "rule": "Для юридических задач — каждое ключевое нормативное утверждение должно иметь ссылку на НПА/статью => FAIL при отсутствии",
                "action_on_fail": "Эскалация к LegalAdvisor и Orchestrator"
            }
        ],
        "metrics_reported": [
            "percent_confirmed_facts",
            "average_source_reliability",
            "conflict_rate",
            "broken_links_count",
            "citation_coverage_percent",
            "critical_triggers_count"
        ]
    },
    "actions_on_trigger": {
        "workflows": {
            "on_WARN": [
                "пометить места для доработки",
                "создать задачу Researcher/Author с приоритетом",
                "перезапустить верификацию после исправлений"
            ],
            "on_FAIL": [
                "остановить автоматический выпуск",
                "эскалировать Orchestrator -> human operator",
                "предоставить детальный quality_report и рекомендации"
            ],
            "on_AUTOMATED_FIX": [
                "для тривиальных проблем (формат, broken links) — создать автоматическую задачу исправления и перезапустить Verifier"
            ]
        },
        "escalation_paths": {
            "to_human_operator": {
                "when": "critical trigger или более 3 итераций без прогресса",
                "payload": [
                    "quality_report",
                    "iteration_log",
                    "conflict_matrix",
                    "recommended_actions"
                ]
            },
            "to_domain_expert": {
                "when": "предметные конфликты или юридические спорные вопросы",
                "payload": [
                    "fact_consistency_report",
                    "sources_list",
                    "draft_document"
                ]
            }
        }
    },
    "report_format_template": {
        "title": "Краткий заголовок (1 строка)",
        "sections": [
            {
                "heading": "Краткое содержание",
                "content_rules": "3–5 предложений: итог и ключевые выводы."
            },
            {
                "heading": "Цель и задачи",
                "content_rules": "Кратко перечислить цель и подзадачи."
            },
            {
                "heading": "Методология",
                "content_rules": "Кто участвовал (agent_id), какие методы использованы."
            },
            {
                "heading": "Ключевые факты и подтверждения",
                "content_rules": "Список фактов с ссылками: {statement, sources, date_accessed, reliability}."
            },
            {
                "heading": "Анализ и аргументация",
                "content_rules": "Короткие абзацы с логикой выводов и альтернативами."
            },
            {
                "heading": "Риски и неопределённости",
                "content_rules": "Перечислить риски и их влияние."
            },
            {
                "heading": "Рекомендации / Решения",
                "content_rules": "Нумерованный список действий с ответственными и сроками."
            },
            {
                "heading": "Источник и подтверждения",
                "content_rules": "Полный список использованных источников в формате: {название, URL, дата доступа, уровень надежности}."
            },
            {
                "heading": "Лог итераций",
                "content_rules": "Хронология изменений: iteration, agent_id, краткое описание, дата."
            }
        ]
    },
    "audit_and_transparency": {
        "versioning": {
            "enabled": true,
            "version_field": "version",
            "hashing": "sha256",
            "store_change_log": true
        },
        "explainability": {
            "record_decision_rationale": true,
            "fields_to_explain": [
                "key_fact_choice",
                "confidence_score",
                "conflict_resolution_decision"
            ]
        },
        "user_control": {
            "allow_log_request": true,
            "log_access_rights": [
                "user",
                "orchestrator",
                "auditor"
            ]
        }
    },
    "templates_and_examples": {
        "example_task_split": {
            "original_task": "Подготовить обоснованную позицию по договорному спору",
            "subtasks": [
                {
                    "name": "Сбор документов",
                    "assigned_to": "researcher_001"
                },
                {
                    "name": "Анализ фактов и хронологии",
                    "assigned_to": "analyst_001"
                },
                {
                    "name": "Черновик претензии",
                    "assigned_to": "author_001"
                },
                {
                    "name": "Юридическое ревью",
                    "assigned_to": "legal_advisor_001"
                },
                {
                    "name": "Рецензия и корректура",
                    "assigned_to": "critic_001"
                },
                {
                    "name": "Верификация качества",
                    "assigned_to": "verifier_001"
                },
                {
                    "name": "Финальная публикация",
                    "assigned_to": "orchestrator_001"
                }
            ]
        },
        "template_output_json_sample": {
            "task_id": "task_20251027_0001",
            "version": 1,
            "author_agent_id": "author_001",
            "title": "Пример: Позиция по договорному спору",
            "summary": "Краткое резюме: выявлены ключевые факты и подготовлены рекомендации.",
            "facts": [
                {
                    "id": "fact_001",
                    "statement": "Договор подписан сторонами 2025-08-15",
                    "sources": [
                        {
                            "url": "https://example.com/contract.pdf",
                            "title": "Договор №123",
                            "date_published": "2025-08-12",
                            "date_accessed": "2025-10-27",
                            "reliability_score": 0.95
                        }
                    ],
                    "confidence_score": 0.98
                }
            ],
            "analysis": "Краткий анализ и логика выводов.",
            "recommendations": [
                {
                    "action": "Направить претензию подрядчику",
                    "responsible": "Юрист",
                    "deadline": "2025-11-05"
                }
            ],
            "quality_metrics": {
                "percent_confirmed_facts": 100,
                "average_source_reliability": 0.95,
                "conflict_rate": 0,
                "broken_links_count": 0,
                "citation_coverage_percent": 100
            },
            "iteration_log": [
                {
                    "iteration": 1,
                    "who": "researcher_001",
                    "what_changed": "Собраны первичные документы",
                    "timestamp": "2025-10-27T12:00:00Z"
                }
            ],
            "final_decision": "released",
            "notes": "Пример шаблона."
        }
    },
    "notes": "Эта конфигурация — единый JSON-файл для мультиагентной оркестрации в универсальном формальном режиме. Пороги, идентификаторы и SLA можно менять в execution_config. Для интеграции с конкретной платформой необходимо сопоставить agent_id с реальными исполнителями и реализовать message routing по interaction_protocol."
}
