# laughing-memory

Telegram-бот на архитектуре **Orchestrator v2**.

## Что поддерживается сейчас
- Единый контракт ответа `OrchestratorResult` для всех обработчиков и инструментов.
- Маршрутизация: команды, smalltalk, summary, обычные вопросы.
- Локальные задачи: `echo`, `upper`, `json_pretty`.
- Меню на inline-кнопках (`/menu`) и wizard-сценарии календаря/напоминаний.
- Напоминания (список, snooze, перенос, отключение).
- Режим фактов (`/facts_on`, `/facts_off`) и контекст диалога.
- Веб-поиск `/search <запрос>` с ответом по источникам и списком источников внизу.

## Команды

### Основные
- `/start` — приветствие и информация
- `/help` — справка по командам
- `/menu` — главное меню с кнопками
- `/ping` — проверка связи

### Задачи
- `/tasks` — список доступных задач
- `/task <name> <payload>` — выполнить задачу
- `/last` — показать последнюю задачу

### LLM инструменты
- `/ask <текст>` — прямой вопрос к LLM
- `/search <запрос>` — веб-поиск с источниками
- `/summary <текст>` — кратко пересказать текст
- `/check <текст>` — проверить текст
- `/rewrite <simple|hard|short> <текст>` — переписать текст
- `/explain <текст>` — объяснить текст
- `/image <описание>` — сгенерировать изображение

### Режим фактов
- `/facts_on` — включить режим фактов (только ответы с источниками)
- `/facts_off` — выключить режим фактов

### Контекст диалога
- `/context_on` — включить сохранение контекста диалога
- `/context_off` — выключить контекст диалога
- `/context_clear` — очистить историю контекста
- `/context_status` — статус контекста

### Утилиты
- `/calc <выражение>` — калькулятор (например: 12*(5+3))
- `/calendar <команда>` — управление календарем
  - `add YYYY-MM-DD HH:MM <название>` — добавить событие
  - `list [YYYY-MM-DD YYYY-MM-DD]` — список событий
  - `today` — события на сегодня
  - `week` — события на неделю
  - `del <id>` — удалить событие

### Напоминания
- `/reminders [N]` — список ближайших напоминаний
- `/reminder_on <event_id>` — включить напоминание
- `/reminder_off <reminder_id>` — выключить напоминание

### Wizard-сценарии
- `/cancel` — отменить активный сценарий

### Admin команды
- `/allow <user_id>` — добавить пользователя в whitelist
- `/deny <user_id>` — удалить пользователя из whitelist
- `/allowlist` — показать whitelist

### Системные
- `/selfcheck` — самопроверка бота
- `/health` — проверка здоровья и статистика

### Обычные сообщения
Обычный текст (без команды) маршрутизируется оркестратором автоматически.


## Result Contract
Поля `OrchestratorResult`:
- `text`, `status`, `mode`, `intent`, `request_id`
- `sources`, `attachments`, `actions`, `debug`

Правила:
- Любой handler/tool возвращает `OrchestratorResult`.
- Перед отправкой в UI применяется `ensure_valid`.

## Запуск
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
python bot.py
```

## Переменные окружения
См. `.env.example` — в файле оставлены только актуальные переменные.

## Тесты
```bash
pytest
```

## Поиск и строгий facts-mode
- `/search` без аргументов возвращает отказ с подсказкой: `Использование: /search <запрос>`.
- `/search <запрос>` выполняет веб-поиск, затем формирует ответ со сносками `[N]` и блоком `Источники:`.
- В режиме фактов (`/facts_on`) ответ допустим только при реальных `sources[]`; если источники не найдены — `refused` без выдумок.
- Анти-псевдоцитаты: ссылки вида `[1]` и блок `Источники:` запрещены, если `sources[]` пустой.
