# laughing-memory

Telegram-–±–æ—Ç –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ **Orchestrator v2**.

## –ß—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å
- –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –æ—Ç–≤–µ—Ç–∞ `OrchestratorResult` –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è: –∫–æ–º–∞–Ω–¥—ã, smalltalk, summary, –æ–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.
- –õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏: `echo`, `upper`, `json_pretty`.
- –ú–µ–Ω—é –Ω–∞ inline-–∫–Ω–æ–ø–∫–∞—Ö (`/menu`) –∏ wizard-—Å—Ü–µ–Ω–∞—Ä–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (—Å–ø–∏—Å–æ–∫, snooze, –ø–µ—Ä–µ–Ω–æ—Å, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ).
- –†–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤ (`/facts_on`, `/facts_off`) ‚Äî —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏.
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (`/context_on`, `/context_off`, `/context_clear`) ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏.
- –í–µ–±-–ø–æ–∏—Å–∫ `/search <–∑–∞–ø—Ä–æ—Å>` —Å –æ—Ç–≤–µ—Ç–æ–º –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –∏ —Å–ø–∏—Å–∫–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤–Ω–∏–∑—É.
- LLM –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `/check`, `/rewrite`, `/explain`.
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ OpenAI DALL-E (`/image <–æ–ø–∏—Å–∞–Ω–∏–µ>`).
- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (`/calc <–≤—ã—Ä–∞–∂–µ–Ω–∏–µ>`).
- –ö–∞–ª–µ–Ω–¥–∞—Ä—å (`/calendar add|list|today|week|del`).

## –ö–æ–º–∞–Ω–¥—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ
- `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `/help` ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ –ø–æ–º–æ—â—å
- `/menu` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
- `/ping` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ (health check)

### –ó–∞–¥–∞—á–∏
- `/tasks` ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á
- `/task <name> <payload>` ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É

### –†–µ–∂–∏–º—ã
- `/facts_on` ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤ (–æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏)
- `/facts_off` ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤
- `/context_on` ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (–∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π)
- `/context_off` ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
- `/context_clear` ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞

### –ü–æ–∏—Å–∫ –∏ LLM
- `/search <–∑–∞–ø—Ä–æ—Å>` ‚Äî –≤–µ–±-–ø–æ–∏—Å–∫ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- `/ask <—Ç–µ–∫—Å—Ç>` ‚Äî –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å LLM
- `/check <—Ç–µ–∫—Å—Ç>` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, —Å—Ç–∏–ª—å)
- `/rewrite <simple|hard|short> <—Ç–µ–∫—Å—Ç>` ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç
- `/explain <—Ç–µ–∫—Å—Ç>` ‚Äî –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- `/summary <—Ç–µ–∫—Å—Ç>` ‚Äî –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–µ–∫—Å—Ç–∞

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- `/calc <–≤—ã—Ä–∞–∂–µ–Ω–∏–µ>` ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
- `/image <–æ–ø–∏—Å–∞–Ω–∏–µ>` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- `/calendar add YYYY-MM-DD HH:MM <–Ω–∞–∑–≤–∞–Ω–∏–µ>` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
- `/calendar list [YYYY-MM-DD YYYY-MM-DD]` ‚Äî —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
- `/calendar today` ‚Äî —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
- `/calendar week` ‚Äî —Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é
- `/calendar del <id>` ‚Äî —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
- `/reminders [N]` ‚Äî —Å–ø–∏—Å–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö N –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è admin)
- `/allow <user_id>` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ whitelist
- `/deny <user_id>` ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ whitelist
- `/allowlist` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å whitelist
- `/health` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–π health check
- `/selfcheck` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### Wizard —Å—Ü–µ–Ω–∞—Ä–∏–∏
- `/cancel` ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π
- –ß–µ—Ä–µ–∑ `/menu` –¥–æ—Å—Ç—É–ø–Ω—ã –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
  - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
  - –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

### –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
- –õ—é–±–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:
  - Smalltalk (–ø—Ä–∏–≤–µ—Ç, –ø–æ–∫–∞, —Å–ø–∞—Å–∏–±–æ)
  - –í–æ–ø—Ä–æ—Å—ã (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ LLM)
  - –ö–æ–º–∞–Ω–¥—ã –∑–∞–¥–∞—á (task:, echo:, upper:, json_pretty:)


## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Orchestrator v2

### –¢–æ–Ω–∫–∏–π —Ñ—Ä–æ–Ω—Ç (Telegram UI)
- **–§–∞–π–ª:** `app/bot/handlers.py`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Telegram Update, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- –í—ã–∑—ã–≤–∞–µ—Ç orchestrator/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ `send_result()`

### –ú–æ–∑–≥-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- **–§–∞–π–ª:** `app/core/orchestrator.py`
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–æ–º–∞–Ω–¥—ã, smalltalk, questions)
- –í—ã–∑–æ–≤ LLM —á–µ—Ä–µ–∑ `_request_llm()`
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `run_fact_answer()`
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–º —Ñ–∞–∫—Ç–æ–≤ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞

### Tool-—Å–ª–æ–π
- `app/tools/web_search.py` ‚Äî –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Perplexity
- `app/core/calc.py` ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
- `app/core/tools_calendar.py` ‚Äî –∫–∞–ª–µ–Ω–¥–∞—Ä—å
- `app/core/reminders.py` ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- `app/core/tools_llm.py` ‚Äî LLM-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### ActionStore
- **–§–∞–π–ª:** `app/bot/actions.py`
- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Å TTL (900 —Å–µ–∫—É–Ω–¥)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è inline-–∫–Ω–æ–ø–æ–∫
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ user_id/chat_id –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## Result Contract
–ü–æ–ª—è `OrchestratorResult`:
- `text` ‚Äî —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)
- `status` ‚Äî ok/refused/error/ratelimited
- `mode` ‚Äî local/llm/tool
- `intent` ‚Äî —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ (command.*, utility.*, etc.)
- `request_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞
- `sources` ‚Äî —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (title, url, snippet)
- `attachments` ‚Äî –≤–ª–æ–∂–µ–Ω–∏—è (image, document)
- `actions` ‚Äî inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `debug` ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)

–ü—Ä–∞–≤–∏–ª–∞:
- –õ—é–±–æ–π handler/tool –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `OrchestratorResult`
- –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ UI –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è `ensure_valid()` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è `ensure_safe_text_strict()` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–æ
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π .env: –¥–æ–±–∞–≤—å BOT_TOKEN, ALLOWED_USER_IDS, API –∫–ª—é—á–∏
python bot.py
```

### Systemd (–ø—Ä–æ–¥–∞–∫—à–Ω)
```bash
sudo cp bot.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable bot
sudo systemctl start bot
sudo systemctl status bot
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `ALLOWED_USER_IDS` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö user_id —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

### Timezone
- `BOT_TIMEZONE` ‚Äî —Ç–∞–π–º–∑–æ–Ω–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `Europe/Vilnius`)

### API –∫–ª—é—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `OPENAI_API_KEY` ‚Äî –¥–ª—è LLM –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `PERPLEXITY_API_KEY` ‚Äî –¥–ª—è –≤–µ–±-–ø–æ–∏—Å–∫–∞

### –ü—É—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `ORCHESTRATOR_CONFIG_PATH` ‚Äî –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `config/orchestrator.json`)
- `BOT_DB_PATH` ‚Äî –ø—É—Ç—å –∫ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `data/bot.db`)
- `ALLOWLIST_PATH` ‚Äî –ø—É—Ç—å –∫ whitelist (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `data/allowlist.json`)
- `CALENDAR_PATH` ‚Äî –ø—É—Ç—å –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `data/calendar.json`)

### –õ–∏–º–∏—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `RATE_LIMIT_PER_MINUTE` ‚Äî –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 6)
- `RATE_LIMIT_PER_DAY` ‚Äî –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 80)

–°–º. `.env.example` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

## –¢–µ—Å—Ç—ã
```bash
pytest                    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
pytest -v                 # Verbose —Ä–µ–∂–∏–º
pytest -xvs               # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ, verbose, –±–µ–∑ capture
pytest tests/test_orchestrator.py  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
```

–í—Å–µ —Ç–µ—Å—Ç—ã: **104 passed** ‚úÖ

## –†–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤ (Truth Protocol)

### –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º
- `/facts_on` ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤
- –û—Ç–≤–µ—Ç—ã **—Ç–æ–ª—å–∫–æ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏** –∏–∑ –≤–µ–±-–ø–æ–∏—Å–∫–∞
- –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Üí `refused` –±–µ–∑ –≤—ã–¥—É–º–æ–∫
- LLM –æ—Ç–≤–µ—á–∞–µ—Ç **—Å—Ç—Ä–æ–≥–æ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º**, –±–µ–∑ –¥–æ–º—ã—Å–ª–æ–≤

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è: `[1]`, `(1)`, "—Å–æ–≥–ª–∞—Å–Ω–æ", "–ø–æ –¥–∞–Ω–Ω—ã–º", URLs, domains
- –ï—Å–ª–∏ `sources[]` –ø—É—Å—Ç, —Ç–æ —Ü–∏—Ç–∞—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ **–∑–∞–ø—Ä–µ—â–µ–Ω—ã**
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è `ensure_safe_text_strict()` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ UI

### –í–µ–±-–ø–æ–∏—Å–∫
- `/search <–∑–∞–ø—Ä–æ—Å>` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Perplexity
- LLM —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å–æ —Å–Ω–æ—Å–∫–∞–º–∏ `[N]`
- –ë–ª–æ–∫ `–ò—Å—Ç–æ—á–Ω–∏–∫–∏:` –≤–Ω–∏–∑—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ URL
- –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–µ—Ç ‚Üí `refused` —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ
- `/context_on` ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- `/context_off` ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å
- `/context_clear` ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é

### –†–∞–±–æ—Ç–∞
- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç LLM
- –£–ª—É—á—à–∞–µ—Ç —Å–≤—è–∑–Ω–æ—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ `data/dialog_memory.json`

## –î–µ–ø–ª–æ–π

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.10+
- Telegram Bot Token
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: OpenAI API Key, Perplexity API Key

### –®–∞–≥–∏
1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pip install -r requirements.txt`
3. –°–æ–∑–¥–∞—Ç—å `.env` –∏–∑ `.env.example`
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
5. –ó–∞–ø—É—Å—Ç–∏—Ç—å: `python bot.py`

### Systemd service
```ini
[Unit]
Description=Telegram Bot Orchestrator v2
After=network.target

[Service]
Type=simple
User=bot
WorkingDirectory=/home/bot/laughing-memory
Environment="PATH=/home/bot/.venv/bin"
ExecStart=/home/bot/.venv/bin/python bot.py
Restart=on-failure
RestartSec=10s

[Install]
WantedBy=multi-user.target
```

## Roadmap

### ‚úÖ –≠—Ç–∞–ø 1 ‚Äî –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- –ï–¥–∏–Ω—ã–π `OrchestratorResult` –¥–ª—è –≤—Å–µ—Ö handlers/tools
- `ensure_valid()` –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ UI

### ‚úÖ –≠—Ç–∞–ø 2 ‚Äî –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ª—é–¥–µ–π
- –ú–µ–Ω—é –Ω–∞ inline-–∫–Ω–æ–ø–∫–∞—Ö
- Wizard framework (state machine)
- –¢–∞–π–º–∞—É—Ç—ã, –æ—Ç–º–µ–Ω–∞, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥

### ‚úÖ –≠—Ç–∞–ø 3 ‚Äî –ü–æ–∏—Å–∫ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç + —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤
- –í–µ–±-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Perplexity
- Strict facts mode
- Truth Protocol (–∑–∞–ø—Ä–µ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

### üîÑ –≠—Ç–∞–ø 4 ‚Äî UX —É–ª—É—á—à–µ–Ω–∏—è (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- –£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫
- –ë–æ–ª—å—à–µ wizard —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## –õ–∏—Ü–µ–Ω–∑–∏—è
MIT
