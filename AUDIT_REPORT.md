# –û—Ç—á—ë—Ç –∞—É–¥–∏—Ç–∞ Telegram-–±–æ—Ç–∞ "–°–µ–∫—Ä–µ—Ç–∞—Ä—å" (Orchestrator v2)

**–î–∞—Ç–∞:** 2026-02-06  
**–í–µ—Ç–∫–∞:** cursor/roadmap-13bf  
**–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤:** ‚úÖ 104/104 passed

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Orchestrator v2

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### 1.1 –¢–æ–Ω–∫–∏–π —Ñ—Ä–æ–Ω—Ç (Telegram UI —Å–ª–æ–π)
- **–§–∞–π–ª:** `app/bot/handlers.py`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- Handlers –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, —Ç–æ–ª—å–∫–æ:
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram Update
  - –í—ã–∑–æ–≤ orchestrator/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
  - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —á–µ—Ä–µ–∑ `send_result()`
  - Rate limiting –∏ access control

#### 1.2 –ú–æ–∑–≥-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- **–§–∞–π–ª:** `app/core/orchestrator.py`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–æ–º–∞–Ω–¥—ã, smalltalk, questions)
- –í—ã–∑–æ–≤ LLM —á–µ—Ä–µ–∑ `_request_llm()`
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `run_fact_answer()`
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–º —Ñ–∞–∫—Ç–æ–≤ `facts_only`
- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ `dialog_context`

#### 1.3 Tool-—Å–ª–æ–π
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- `app/tools/web_search.py` - –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Perplexity
- `app/core/calc.py` - –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
- `app/core/tools_calendar.py` - –∫–∞–ª–µ–Ω–¥–∞—Ä—å
- `app/core/reminders.py` - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- `app/core/tools_llm.py` - LLM-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (check, rewrite, explain)

#### 1.4 ActionStore
- **–§–∞–π–ª:** `app/bot/actions.py`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Å TTL (900 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è inline-–∫–Ω–æ–ø–æ–∫
- –°–µ–∫—å—é—Ä–∏—Ç–∏: –ø—Ä–∏–≤—è–∑–∫–∞ –∫ user_id/chat_id

#### 1.5 –ï–¥–∏–Ω—ã–π Result Contract
- **–§–∞–π–ª:** `app/core/result.py`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- `OrchestratorResult` —Å –ø–æ–ª—è–º–∏: `text`, `status`, `mode`, `intent`, `request_id`, `sources`, `attachments`, `actions`, `debug`
- –§—É–Ω–∫—Ü–∏–∏-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã: `ok()`, `refused()`, `error()`, `ratelimited()`
- `ensure_valid()` –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `validate()`
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ `actions` –∏ `debug`

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏

#### 1.6 Truth Protocol (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤)
- **–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ï—Å—Ç—å `ensure_safe_text_strict()` - –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–∏
- ‚úÖ –ï—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è: `[1]`, `(1)`, "—Å–æ–≥–ª–∞—Å–Ω–æ", "–ø–æ –¥–∞–Ω–Ω—ã–º", URLs, domains
- ‚úÖ –í `facts_only` —Ä–µ–∂–∏–º–µ –æ—Ç–∫–∞–∑ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö sources
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤–µ–∑–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è `ensure_safe_text_strict` –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É

#### 1.7 Timezone (Europe/Vilnius)
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Europe/Moscow` –≤–º–µ—Å—Ç–æ `Europe/Vilnius`
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** –í `calendar_store.py` —Å—Ç—Ä–æ–∫–∏ 13-15:
  ```python
  BOT_TZ = ZoneInfo(os.getenv("BOT_TIMEZONE", "Europe/Moscow"))
  MOSCOW_TZ = BOT_TZ
  VIENNA_TZ = BOT_TZ  # backward compatible alias
  ```
- ‚úÖ –•–æ—Ä–æ—à–æ: –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `MOSCOW_TZ/VIENNA_TZ`, –∞ –Ω–µ naive datetime
- ‚úÖ –•–æ—Ä–æ—à–æ: –ø–∞—Ä—Å–∏–Ω–≥ datetime –≤—Å–µ–≥–¥–∞ —Å timezone

---

## 2. –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (Result Contract)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

1. **ensure_valid()** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
   - ‚úÖ `text` –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "")
   - ‚úÖ `status` –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∫ ok/refused/error
   - ‚úÖ `intent` –≤—Å–µ–≥–¥–∞ –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (fallback "unknown")
   - ‚úÖ `mode` –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∫ local/llm/tool
   - ‚úÖ `sources`, `actions`, `attachments`, `debug` –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ (list/dict)

2. **send_result()** –≤ handlers.py:
   - ‚úÖ –í—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `result.text`
   - ‚úÖ –†–µ–Ω–¥–µ—Ä–∏—Ç `result.actions` –∫–∞–∫ inline-–∫–Ω–æ–ø–∫–∏
   - ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `attachments` (image/document)
   - ‚úÖ `debug` –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç `ensure_safe_text_strict` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   - ‚úÖ –†–µ–Ω–¥–µ—Ä–∏—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–Ω–∏–∑—É —Ç–µ–∫—Å—Ç–∞

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- **–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç:** –í `send_result()` —Å—Ç—Ä–æ–∫–∞ 564:
  ```python
  if not public_result.text.strip():
      public_result = replace(public_result, text="–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞.")
  ```
  –•–æ—Ä–æ—à–æ, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ —Ç–µ—Å—Ç–∞–º–∏.

---

## 3. Truth Protocol (—Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º —Ñ–∞–∫—Ç–æ–≤:**
   - ‚úÖ `orchestrator.is_facts_only(user_id)` - —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞
   - ‚úÖ –í `_build_llm_result()` (—Å—Ç—Ä–æ–∫–∞ 815): –æ—Ç–∫–∞–∑ –ø—Ä–∏ `facts_only=True` –±–µ–∑ sources
   - ‚úÖ –í `run_fact_answer()` (—Å—Ç—Ä–æ–∫–∞ 654): –æ—Ç–∫–∞–∑ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö sources

2. **–ó–∞–ø—Ä–µ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:**
   - ‚úÖ `ensure_safe_text_strict()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   - ‚úÖ –ë–ª–æ–∫–∏—Ä—É–µ—Ç: `[1]`, `(1)`, "—Å–æ–≥–ª–∞—Å–Ω–æ", "–ø–æ –¥–∞–Ω–Ω—ã–º", URLs, domains
   - ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `STRICT_REFUSAL_TEXT` –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏

3. **Web search:**
   - ‚úÖ `PerplexityWebSearchClient` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç sources
   - ‚úÖ `Source(title, url, snippet)`
   - ‚úÖ Fetch title/description –∏–∑ HTML meta-—Ç–µ–≥–æ–≤

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ orchestrator:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `ensure_safe_text_strict` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è LLM-—Ç–µ–∫—Å—Ç –±–µ–∑ sources.

---

## 4. Timezone –∏ naive datetime

### ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **Timezone:**
   - ‚ùå –°–µ–π—á–∞—Å: `Europe/Moscow` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   - ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è: `Europe/Vilnius`
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å: `calendar_store.py` —Å—Ç—Ä–æ–∫–∞ 13 –∏ `.env.example`

2. **Naive datetime:**
   - ‚úÖ –•–æ—Ä–æ—à–æ: `parse_local_datetime()` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç tz-aware
   - ‚úÖ –•–æ—Ä–æ—à–æ: `_parse_datetime()` –≤—Å–µ–≥–¥–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∫ tz-aware
   - ‚úÖ –•–æ—Ä–æ—à–æ: –≤—Å–µ datetime –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `MOSCOW_TZ`

---

## 5. Fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- **–§–∞–π–ª:** `app/bot/handlers.py`, —Ñ—É–Ω–∫—Ü–∏—è `unknown_command()`
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `refused` —Å —Ç–µ–∫—Å—Ç–æ–º "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞."
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç action –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
- ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `bot.py` —á–µ—Ä–µ–∑ `MessageHandler(filters.COMMAND, handlers.unknown_command)`

---

## 6. UI –æ—Ç–ø—Ä–∞–≤–∫–∞ (send_result)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞:**
   - ‚úÖ –í—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `result.text` (–¥–∞–∂–µ –ø—Ä–∏ refused/error)
   - ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç `ensure_safe_text_strict` –¥–ª—è –∑–∞—â–∏—Ç—ã
   - ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–Ω–∏–∑—É —á–µ—Ä–µ–∑ `_render_text_with_sources()`
   - ‚úÖ Fallback "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞." –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ç–µ–∫—Å—Ç–µ

2. **–ö–Ω–æ–ø–∫–∏:**
   - ‚úÖ `build_inline_keyboard()` —Å–æ–∑–¥–∞—ë—Ç InlineKeyboardMarkup
   - ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ ActionStore —Å TTL
   - ‚úÖ Callback data: —Ç–æ–∫–µ–Ω –¥–ª—è lookup

3. **–í–ª–æ–∂–µ–Ω–∏—è:**
   - ‚úÖ `_send_attachments()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç image/document
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ url, bytes, path

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - ‚úÖ `_log_orchestrator_result()` –ª–æ–≥–∏—Ä—É–µ—Ç intent, status, sources, actions

---

## 7. Wizard framework

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

1. **State machine:**
   - ‚úÖ `app/core/wizard_runtime.py` - –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π Wizard –∏ Step
   - ‚úÖ `app/core/wizard_manager.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
   - ‚úÖ `app/storage/wizard_store.py` - –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ

2. **–û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
   - ‚úÖ `calendar_add` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
   - ‚úÖ `reminder_create` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
   - ‚úÖ `reminder_reschedule` - –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

3. **–§—É–Ω–∫—Ü–∏–∏:**
   - ‚úÖ –¢–∞–π–º–∞—É—Ç—ã (600 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   - ‚úÖ –û—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ `/cancel` –∏–ª–∏ action
   - ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ (restart)
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
   - ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

### ‚ö†Ô∏è –ó–∞–º–µ—á–∞–Ω–∏—è

- Wizard framework —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ö–æ—Ä–æ—à–æ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è, –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏ —Ç.–¥.)

---

## 8. Web search –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

1. **–§–æ—Ä–º–∞—Ç sources:**
   - ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: `Source(title, url, snippet)`
   - ‚úÖ Fetch metadata –∏–∑ HTML (title, description)
   - ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è URLs
   - ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

2. **Strict facts mode:**
   - ‚úÖ –í `run_fact_answer()`: –æ—Ç–∫–∞–∑ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö sources
   - ‚úÖ LLM-–ø—Ä–æ–º–ø—Ç —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
   - ‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ `render_fact_response_with_sources()`

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - ‚úÖ `PerplexityWebSearchClient` —á–µ—Ä–µ–∑ Perplexity API
   - ‚úÖ Timeout 4 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è fetch HTML
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: query, sources count, latency

---

## 9. –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ)

1. ‚ùå **Timezone:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Europe/Moscow` –≤–º–µ—Å—Ç–æ `Europe/Vilnius`
   - **–§–∞–π–ª:** `app/core/calendar_store.py:13`
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç –Ω–∞ `Europe/Vilnius`

### –°—Ä–µ–¥–Ω–∏–µ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)

2. ‚ö†Ô∏è **Inconsistent timezone naming:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–ª–∏–∞—Å—ã `MOSCOW_TZ`, `VIENNA_TZ`, `BOT_TZ` –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
   - **–§–∞–π–ª:** `app/core/calendar_store.py:13-15`
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ü—Ä–∏–≤–µ—Å—Ç–∏ –∫ –µ–¥–∏–Ω–æ–º—É `BOT_TZ`, –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

3. ‚ö†Ô∏è **README —É—Å—Ç–∞—Ä–µ–ª:** –ù–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Ä–µ–∂–∏–º—ã
   - **–§–∞–π–ª:** `README.md`
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ wizards, —Ä–µ–∂–∏–º–µ context, –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö

4. ‚ö†Ô∏è **.env.example:** –ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `BOT_TIMEZONE`
   - **–§–∞–π–ª:** `.env.example`
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `BOT_TIMEZONE="Europe/Vilnius"`

### –ù–∏–∑–∫–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ)

5. üí° **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (JSON logs)
6. üí° **Wizard —Å—Ü–µ–Ω–∞—Ä–∏–∏:** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)

---

## 10. –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

### ‚úÖ –•–æ—Ä–æ—à–æ –ø–æ–∫—Ä—ã—Ç–æ

- ‚úÖ Result Contract (test_result_contract.py)
- ‚úÖ Strict facts mode (test_pseudo_sources.py, test_search_pipeline.py)
- ‚úÖ Web search (test_web_search.py)
- ‚úÖ Calendar/reminders (test_calendar_reminders.py, test_calendar_parse.py)
- ‚úÖ Wizards (test_wizard_*.py)
- ‚úÖ Actions UI (test_actions_ui.py)
- ‚úÖ Routing (test_routing.py)
- ‚úÖ Unknown commands (test_unknown_command.py)
- ‚úÖ LLM integration (test_llm.py)

### ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (user -> handlers -> orchestrator -> tools -> UI)
- –¢–µ—Å—Ç—ã timezone consistency

---

## 11. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ

1. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å timezone –Ω–∞ `Europe/Vilnius`
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `.env.example`
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å README

### –í —Å–ª–µ–¥—É—é—â–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö

4. –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ wizard —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
5. –£–ª—É—á—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
6. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
7. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (–¥–∏–∞–≥—Ä–∞–º–º—ã, sequence diagrams)

---

## 12. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** üü¢ **–•–æ—Ä–æ—à–æ**

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Orchestrator v2 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:
- ‚úÖ –¢–æ–Ω–∫–∏–π —Ñ—Ä–æ–Ω—Ç
- ‚úÖ –ú–æ–∑–≥-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- ‚úÖ Tool-—Å–ª–æ–π
- ‚úÖ –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç
- ‚úÖ Truth Protocol (—á–∞—Å—Ç–∏—á–Ω–æ)
- ‚úÖ ActionStore
- ‚úÖ Wizard framework
- ‚ùå Timezone —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ö–æ–¥ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–∏—Å—Ç–∞—è –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è.

**–ë–ª–æ–∫–µ—Ä—ã:** –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω - timezone Europe/Vilnius –≤–º–µ—Å—Ç–æ Europe/Moscow.
