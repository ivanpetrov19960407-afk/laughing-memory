# –ê—É–¥–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Orchestrator v2 (Orchestrator v2 + roadmap)

**–î–∞—Ç–∞:** 2026-02-06  
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** `ivanpetrov19960407-afk/laughing-memory` (–≤–µ—Ç–∫–∞ `main`)

---

## –≠–¢–ê–ü 1. –ê–£–î–ò–¢

### 1.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Orchestrator v2

**‚úÖ –•–û–†–û–®–û:**
- –ü—Ä–∏–Ω—Ü–∏–ø—ã Orchestrator v2 —Å–æ–±–ª—é–¥–µ–Ω—ã
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç Telegram handlers
- –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (tasks, tools_llm, tools_calendar, wizard) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `OrchestratorResult`
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç `OrchestratorResult` —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ `app/core/result.py`

**‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `OrchestratorResult` ‚Äî frozen dataclass —Å –ø–æ–ª—è–º–∏: text, status, mode, intent, request_id, sources, actions, attachments, debug
- –•–µ–ª–ø–µ—Ä—ã: `ok()`, `error()`, `refused()`, `ratelimited()` ‚Äî –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `ensure_valid()` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- `ensure_safe_text_strict()` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 1.2 –ö–æ–Ω—Ç—Ä–∞–∫—Ç OrchestratorResult

**‚úÖ –í—Å–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç:**
- ‚úÖ `text: str` ‚Äî —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
- ‚úÖ `status: ResultStatus` ‚Äî ok/refused/error/ratelimited
- ‚úÖ `mode: ResultMode` ‚Äî local/llm/tool
- ‚úÖ `intent: str` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏—è
- ‚úÖ `request_id: str` ‚Äî ID –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ `sources: list[Source]` ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- ‚úÖ `actions: list[Action]` ‚Äî –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è UI
- ‚úÖ `attachments: list[Attachment]` ‚Äî –≤–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ `debug: dict[str, Any]` ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**‚úÖ –¢–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã:**
- –í—Å–µ –ø–æ–ª—è –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã
- –°—Ç–∞—Ç—É—Å—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è: ok/refused/error/ratelimited
- –†–µ–∂–∏–º—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è: local/llm/tool
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `.validate()` –º–µ—Ç–æ–¥

### 1.3 –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞

**‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- ‚úÖ `ensure_valid()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Å—Ç–∞—Ö:
  - –í handlers –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π: `send_result()` (—Å—Ç—Ä–æ–∫–∞ 553, 559)
  - –í orchestrator –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  - –í –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö (tools_llm, tools_calendar)

**‚ö†Ô∏è –ó–ê–ú–ï–ß–ê–ù–ò–Ø –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è):**
- `ensure_valid()` —Ä–∞–Ω—å—à–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª –Ω–µ –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã (`ratelimited`) –∏ –Ω–µ –ø—Ä–∏–≤–æ–¥–∏–ª —ç–ª–µ–º–µ–Ω—Ç—ã `sources/actions/attachments` –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º—É —Ç–∏–ø—É.
- –í `ensure_valid()` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∏—Å—Ç–∫–∞ ‚Äú—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö‚Äù —Å—Å—ã–ª–æ–∫/—Ü–∏—Ç–∞—Ç –≤ `text`, –∫–æ–≥–¥–∞ `sources[]` –ø—É—Å—Ç.
- –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Telegram UI –Ω–µ –±—ã–ª–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–Ω–∞–ª—å–Ω–æ–π `.validate()` (—Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞).

### 1.4 Handlers (Telegram —Å–ª–æ–π)

**‚úÖ Handlers –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã:**
- ‚úÖ Handlers —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤—ã–∑—ã–≤–∞—é—Ç `send_result()`)
- ‚úÖ Handlers –ù–ï —Ä–µ—à–∞—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- ‚úÖ Handlers –ù–ï —Ñ–æ—Ä–º–∏—Ä—É—é—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –≤—Ä—É—á–Ω—É—é (–¥–µ–ª–µ–≥–∏—Ä—É—é—Ç Orchestrator)
- ‚úÖ Handlers –ù–ï –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç intent/status

---

## –≠–¢–ê–ü 2. –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è Result Contract –ø–µ—Ä–µ–¥ Telegram UI

- **–§–∞–π–ª—ã:** `app/core/result.py`, `app/bot/handlers.py`
- **–°—É—Ç—å:** –∫–æ–Ω—Ç—Ä–∞–∫—Ç `OrchestratorResult` —Ç–µ–ø–µ—Ä—å –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∂–µ:
  - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è `status/mode/intent`,
  - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π non-empty `text`,
  - —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã `sources/actions/attachments/debug`,
  - —á–∏—Å—Ç–∫–∞ –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤/—Ü–∏—Ç–∞—Ç –≤ `text` –ø—Ä–∏ –ø—É—Å—Ç–æ–º `sources[]`,
  - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è `.validate()` –≤ UI –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (—Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ).

---

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –¢–∞–π–º–∑–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Europe/Vilnius (–±–µ–∑ naive datetime)

**–§–∞–π–ª—ã:** `app/core/calendar_store.py`, `.env.example`, `README.md`

**–°—É—Ç—å:** –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è TZ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ `Europe/Vilnius` (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `BOT_TIMEZONE`).  
–í –∫–∞–ª–µ–Ω–¥–∞—Ä–µ/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö –∑–∞–ø—Ä–µ—â–µ–Ω—ã naive datetime ‚Äî –≤—Å–µ –¥–∞—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `tzinfo`.

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: UX ‚Äî fallback –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –≤–ª–æ–∂–µ–Ω–∏—è (image)

- **–§–∞–π–ª—ã:** `app/bot/handlers.py`, `app/core/orchestrator.py`
- **–°—É—Ç—å:**
  - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `refused` —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –æ—Ç–∫—Ä—ã—Ç—å `/menu`,
  - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç `io` –¥–ª—è bytes-attachments).

---

### ‚ö†Ô∏è –ó–ê–ú–ï–ß–ê–ù–ò–ï 2: Wizard –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑ ensure_valid

**–§–∞–π–ª:** `app/bot/wizard.py`  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** 57 –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ `ok()`, `error()`, `refused()` –ë–ï–ó `ensure_valid()`

**–ü—Ä–∏–º–µ—Ä—ã:**
- –°—Ç—Ä–æ–∫–∞ 49: `return refused("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π. –û—Ç–∫—Ä–æ–π /menu.", intent="wizard.unknown", mode="local", actions=_menu_actions())`
- –°—Ç—Ä–æ–∫–∞ 94: `return refused("–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–º–µ–Ω—ë–Ω.", intent="wizard.cancel", mode="local", actions=_menu_actions())`
- –ò —Ç.–¥.

**–ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- `send_result()` –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `ensure_valid()` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (handlers.py:553)
- –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã wizard –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `send_result()`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å `ensure_valid()` –≤ wizard –¥–ª—è "defense in depth"
- –õ–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —á—Ç–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `send_result()`

---

## –≠–¢–ê–ü 3. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**Orchestrator:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ `handle()` (orchestrator.py:132)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ `handle_text()` (orchestrator.py:452)
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –≤—Ö–æ–¥–∞: 5500 —Å–∏–º–≤–æ–ª–æ–≤ (orchestrator.py:81)

**Handlers:**
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö handlers

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤

**Orchestrator:**
- ‚úÖ `_MAX_INPUT_LENGTH = 5500` (orchestrator.py:81)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `_make_decision()` (orchestrator.py:837)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `handle_text()` (orchestrator.py:461)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `_request_llm()` (orchestrator.py:276)

### ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–¥–µ–Ω–∏–π –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ü—É—Å—Ç–æ–π `sources`: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (default_factory=list)
- ‚úÖ –ü—É—Å—Ç–æ–π `actions`: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (default_factory=list)
- ‚úÖ –ü—É—Å—Ç–æ–π `attachments`: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (default_factory=list)

**–ü—Ä–∏–º–µ—Ä—ã:**
- `ensure_valid()` –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç None ‚Üí [] –¥–ª—è –≤—Å–µ—Ö —Å–ø–∏—Å–∫–æ–≤—ã—Ö –ø–æ–ª–µ–π (result.py:265-275)
- `send_result()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –∏ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–∞ "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞." (handlers.py:560)

### ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ: ok, refused, error, ratelimited
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ `ensure_valid()` (result.py:243-245)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ `OrchestratorResult.validate()` (result.py:93)

---

## –≠–¢–ê–ü 4. –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Orchestrator v2 —Å–æ–±–ª—é–¥–µ–Ω–∞:**
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤ (handlers ‚Üí orchestrator ‚Üí tools)
   - –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `OrchestratorResult`
   - –ö–æ–Ω—Ç—Ä–∞–∫—Ç `OrchestratorResult` —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - `ensure_valid()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö (handlers.send_result)
   - `ensure_safe_text_strict()` –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –∏ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –≤—Ö–æ–¥–æ–≤
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –≤—Ö–æ–¥–∞ (5500 —Å–∏–º–≤–æ–ª–æ–≤)
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
   - Fallback –∑–Ω–∞—á–µ–Ω–∏—è –≤ `ensure_valid()`

### üî¥ –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

1. **–ö–†–ò–¢–ò–ß–ù–û: Unreachable code**
   - –§–∞–π–ª: `app/bot/handlers.py:1789`
   - –î–µ–π—Å—Ç–≤–∏–µ: –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π `return refused()`

### ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `dataclasses.replace()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è**
   - –§–∞–π–ª: `app/bot/handlers.py:561-571`
   - –î–µ–π—Å—Ç–≤–∏–µ: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `replace(public_result, text="–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞.")`

2. **–î–æ–±–∞–≤–∏—Ç—å `ensure_valid()` –≤ wizard (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
   - –§–∞–π–ª: `app/bot/wizard.py` (57 –º–µ—Å—Ç)
   - –î–µ–π—Å—Ç–≤–∏–µ: –û–±–µ—Ä–Ω—É—Ç—å –≤—Å–µ –≤–æ–∑–≤—Ä–∞—Ç—ã –≤ `ensure_valid()` –¥–ª—è "defense in depth"
   - –õ–∏–±–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —á—Ç–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `send_result()`

3. **TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:**
   - `app/core/tasks.py:38` ‚Äî TODO –ø—Ä–æ C extension tasks (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ö–æ–¥ –≤ —Ü–µ–ª–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ Orchestrator v2 –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.**

**–ù–∞–π–¥–µ–Ω–æ:**
- 1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (unreachable code)
- 2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Orchestrator v2
- ‚úÖ –ö–æ–Ω—Ç—Ä–∞–∫—Ç OrchestratorResult —Å–æ–±–ª—é–¥–µ–Ω
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å unreachable code –≤ handlers.py:1789
2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–æ–±–∞–≤–∏—Ç—å ensure_valid() –≤ wizard –¥–ª—è consistency

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º, —Å —É—Å–∏–ª–µ–Ω–∏–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏ TZ.
