# Stage 6.5: FileReader ‚Äî PR –æ–ø–∏—Å–∞–Ω–∏–µ

## –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–∏—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (PDF/DOCX/IMG), –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, —Ä–µ–∂–∏–º—ã ¬´–†–µ–∑—é–º–µ¬ª –∏ ¬´–í–æ–ø—Ä–æ—Å—ã –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É¬ª, –±–µ–∑ –ø–æ–ª–æ–º–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–¥-UX –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ Orchestrator v2.

## –†–µ—à–µ–Ω–∏—è –ø–æ —Ö—Ä–∞–Ω–µ–Ω–∏—é
- **–î–∏—Å–∫:** —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ:
  - `UPLOADS_PATH` / `DOCUMENT_TEXTS_PATH` (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: `{path}/{user_id}/...`).
- **–°–µ—Å—Å–∏–∏:** –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–π (doc_id, user_id, chat_id, state, expires_at, –ø—É—Ç–∏ –∫ file_path/text_path) ‚Äî –≤ JSON-—Ñ–∞–π–ª–µ `DOCUMENT_SESSIONS_PATH`.
- **–ü–∞–º—è—Ç—å:** –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –¥–µ—Ä–∂–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏; —á–∏—Ç–∞–µ—Ç—Å—è —Å –¥–∏—Å–∫–∞ –ø—Ä–∏ —Ä–µ–∑—é–º–µ/Q&A. –õ–∏–º–∏—Ç—ã (DOC_MAX_CHARS, DOC_MAX_PAGES) —É–º–µ–Ω—å—à–∞—é—Ç –æ–±—ä—ë–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
- **–ü–æ—á–µ–º—É –¥–∏—Å–∫:** —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ (uploads_path, document_texts_path); –ø—Ä–æ—â–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –∏ –æ—á–∏—Å—Ç–∫—É; –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–µ—Å—Å–∏–∏ –∏ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–æ TTL/–æ—á–∏—Å—Ç–∫–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ö–æ–Ω—Ñ–∏–≥ (ENV)
- `DOC_SESSION_TTL_SECONDS` (7200), `FILE_MAX_BYTES_PDF_DOCX` (10M), `FILE_MAX_BYTES_IMG` (5M), `DOC_MAX_CHARS` (200k), `DOC_MAX_PAGES` (50), `TESSERACT_LANG` (rus+eng), `FILE_STORAGE_DIR`.

### DocumentSessionStore
- –ü–æ–ª–µ `expires_at` —É —Å–µ—Å—Å–∏–∏; TTL –∑–∞–¥–∞—ë—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
- `get_active_with_status()` / `get_session_with_status()` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç–∞—Ç—É—Å `ok` | `expired` | `none` –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è ¬´–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞¬ª.
- –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL —Å–µ—Å—Å–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏.

### FileTextExtractor
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `extract_from_bytes()` –¥–ª—è PDF/DOCX/image.
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (—Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤), –ª–∏–º–∏—Ç—ã –ø–æ —Å–∏–º–≤–æ–ª–∞–º/—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º, `warnings` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.
- –Ø–∑—ã–∫ Tesseract –∑–∞–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `tesseract_lang` (ENV).

### document_qa
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω regex —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏: `[\w\-]+`.
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `[]` ‚Üí –æ—Ç–≤–µ—Ç ¬´–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ –Ω–∞—à—ë–ª –æ—Ç–≤–µ—Ç–∞¬ª.
- –î–æ–±–∞–≤–ª–µ–Ω–∞ `select_relevant_chunks_with_scores()` –¥–ª—è fallback –±–µ–∑ LLM (—Ü–∏—Ç–∞—Ç—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤).

### Handlers
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –¥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è; –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—É—Ç–µ–π (path traversal).
- –ü–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `file_received`, `text_extracted`, `doc_session_started/stopped/expired`, `qa_query` (–±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞).
- –†–µ–∑—é–º–µ: —Å LLM ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ; –±–µ–∑ LLM ‚Äî —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ (–ø–µ—Ä–≤—ã–µ –∞–±–∑–∞—Ü—ã + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞).
- Q&A: —Å LLM ‚Äî –æ—Ç–≤–µ—Ç –ø–æ —á–∞–Ω–∫–∞–º; –±–µ–∑ LLM ‚Äî –¥–æ 3 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∫–∞–∫ —Ü–∏—Ç–∞—Ç—ã.
- –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç¬ª ‚Äî üßπ.
- –ö–æ–º–∞–Ω–¥—ã `/doc_close`, `/doc_status`.

### –¢–µ—Å—Ç—ã
- PDF/DOCX/bytes extraction, Q&A (no-match ‚Üí –ø—É—Å—Ç–æ, match ‚Üí —á–∞–Ω–∫–∏), TTL –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç ‚Üí –∫–Ω–æ–ø–∫–∏ ‚Üí –∑–∞–∫—Ä—ã—Ç—å).

## –†–µ–≥—Ä–µ—Å—Å–∏–∏
- –ù–µ –º–µ–Ω—è–ª–∏—Å—å –ø—É–±–ª–∏—á–Ω—ã–µ UX-–ø—É—Ç–∏ (/menu –∏ —Ç.–¥.); –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏—ë–º —Ñ–∞–π–ª–æ–≤, –∫–Ω–æ–ø–∫–∏ –∏ –∫–æ–º–∞–Ω–¥—ã `/doc_close`, `/doc_status`.
- –í—Å–µ 263 —Ç–µ—Å—Ç–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç.

## Docker/CI
- Dockerfile –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω; –≤ README —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –¥–ª—è OCR –≤ Docker –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `tesseract-ocr` –∏ —è–∑—ã–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã. CI (pytest) –∑–µ–ª—ë–Ω—ã–π.
